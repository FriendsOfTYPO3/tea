---
addons:
  apt:
    packages:
      - parallel
before_install:
  - "phpenv config-rm xdebug.ini || echo \"xdebug not available\""
cache:
  directories:
    - $HOME/.composer/cache
env:
  global:
    - "typo3DatabaseHost=localhost typo3DatabaseName=typo3 typo3DatabaseUsername=travis typo3DatabasePassword=''"
install:
  - "composer require typo3/minimal:\"$TYPO3\"; composer show;\n"
  - "echo; echo \"Restoring the composer.json\"; git checkout .;\n"
jobs:
  include:
    -
      env: TYPO3=^9.5
      php: "7.3"
      stage: test
    -
      env: TYPO3=^9.5
      php: "7.2"
      stage: test
    -
      before_install: skip
      before_script: skip
      if: "tag IS present AND env(TYPO3_ORG_USERNAME) IS present AND env(TYPO3_ORG_PASSWORD) IS present"
      install: skip
      php: "7.2"
      script:
        - "echo; echo \"Preparing upload of release ${TRAVIS_TAG} to TER\"; echo; echo; composer global require helhum/ter-client;\n"
        - "TAG_MESSAGE=`git tag -n10 -l $TRAVIS_TAG | sed 's/^[0-9.]*[ ]*//g'`; echo; echo \"Uploading release ${TRAVIS_TAG} to TER\"; echo; echo; $HOME/.composer/vendor/bin/ter-client upload tea . -u \"$TYPO3_ORG_USERNAME\" -p \"$TYPO3_ORG_PASSWORD\" -m \"$TAG_MESSAGE\";\n"
      stage: "release to ter"
language: php
script:
  - "echo; echo \"Running the functional tests\"; composer ci:tests:functional;\n"
services:
  - mysql
sudo: false
