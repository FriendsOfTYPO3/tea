---
stages:
  - build
  - lint
  - codestyle
  - normalize
  - test

include:
  - '/templates/.default.yml'
  - '/templates/.default-frontend.yml'
  - '/templates/build-composer-dependencies.yml'
  - '/templates/php-lint-php7.2.yml'
  - '/templates/php-lint-php7.3.yml'
  - '/templates/php-lint-php7.4.yml'
  - '/templates/ts-lint.yml'
  - '/templates/json-lint.yml'
  - '/templates/yaml-lint.yml'
  - '/templates/xliff-lint.yml'
  - '/templates/javascript-lint.yml'
  - template: Security/License-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml

variables:
  MYSQL_ROOT_PASSWORD: root
  typo3DatabaseName: typo3
  typo3DatabaseHost: mariadb
  typo3DatabaseUsername: root
  typo3DatabasePassword: root

unit-php7.2-v10:
  extends: .default
  image: php:7.2
  stage: test
  needs:
    - build-composer-dependencies
    - php-lint-php7.2
  script:
    - composer require --no-progress typo3/minimal:"^10.4"
    - composer ci:tests:unit

unit-php7.3-v10:
  extends: .default
  image: php:7.3
  stage: test
  needs:
    - build-composer-dependencies
    - php-lint-php7.3
  script:
    - composer require --no-progress typo3/minimal:"^10.4"
    - composer ci:tests:unit

unit-php7.4-v10:
  extends: .default
  image: php:7.4
  stage: test
  needs:
    - build-composer-dependencies
    - php-lint-php7.4
  script:
    - composer require --no-progress typo3/minimal:"^10.4"
    - composer ci:tests:unit

func-php7.2-v10:
  extends: .default
  image: php:7.2
  services:
    - mariadb:10
  stage: test
  needs:
    - build-composer-dependencies
    - php-lint-php7.2
  script:
    - composer require --no-progress typo3/minimal:"^10.4"
    - composer ci:tests:functional

func-php7.3-v10:
  extends: .default
  image: php:7.3
  services:
    - mariadb:10
  stage: test
  needs:
    - build-composer-dependencies
    - php-lint-php7.3
  script:
    - composer require --no-progress typo3/minimal:"^10.4"
    - composer ci:tests:functional

func-php7.4-v10:
  extends: .default
  image: php:7.4
  services:
    - mariadb:10
  stage: test
  needs:
    - build-composer-dependencies
    - php-lint-php7.4
  script:
    - composer require --no-progress typo3/minimal:"^10.4"
    - composer ci:tests:functional

unit-php7.2-v9:
  extends: .default
  image: php:7.2
  stage: test
  dependencies: [ ]
  needs:
    - build-composer-dependencies
    - php-lint-php7.2
  script:
    - composer require --no-progress typo3/minimal:"^9.5"
    - composer ci:tests:unit

unit-php7.3-v9:
  extends: .default
  image: php:7.3
  stage: test
  dependencies: [ ]
  needs:
    - build-composer-dependencies
    - php-lint-php7.3
  script:
    - composer require --no-progress typo3/minimal:"^9.5"
    - composer ci:tests:unit

unit-php7.4-v9:
  extends: .default
  image: php:7.4
  stage: test
  dependencies: [ ]
  needs:
    - build-composer-dependencies
    - php-lint-php7.4
  script:
    - composer require --no-progress typo3/minimal:"^9.5"
    - composer ci:tests:unit

func-php7.2-v9:
  extends: .default
  image: php:7.2
  services:
    - mariadb:10
  stage: test
  dependencies: [ ]
  needs:
    - build-composer-dependencies
    - php-lint-php7.2
  script:
    - composer require --no-progress typo3/minimal:"^9.5"
    - composer ci:tests:functional

func-php7.3-v9:
  extends: .default
  image: php:7.3
  services:
    - mariadb:10
  stage: test
  dependencies: [ ]
  needs:
    - build-composer-dependencies
    - php-lint-php7.3
  script:
    - composer require --no-progress typo3/minimal:"^9.5"
    - composer ci:tests:functional

func-php7.4-v9:
  extends: .default
  image: php:7.4
  services:
    - mariadb:10
  stage: test
  dependencies: [ ]
  needs:
    - build-composer-dependencies
    - php-lint-php7.4
  script:
    - composer require --no-progress typo3/minimal:"^9.5"
    - composer ci:tests:functional

phpcs:
  extends: .default
  stage: codestyle
  needs:
    - build-composer-dependencies
    - php-lint-php7.2
    - php-lint-php7.3
    - php-lint-php7.4
  script:
    - composer ci:php:sniff

php-copypaste-check:
  extends: .default
  stage: codestyle
  needs:
    - build-composer-dependencies
    - php-lint-php7.2
    - php-lint-php7.3
    - php-lint-php7.4
  script:
    - composer ci:php:copypaste

phpstan:
  extends: .default
  stage: codestyle
  needs:
    - build-composer-dependencies
    - php-lint-php7.2
    - php-lint-php7.3
    - php-lint-php7.4
  script:
    - composer ci:php:stan

composer-normalize:
  extends: .default
  stage: codestyle
  script:
    - composer ci:composer:normalize
